name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Kubernetes Deployment Image
        shell: powershell
        run: |
          # Replace placeholder with actual DockerHub username in deployment.yaml
          $content = Get-Content k8s/deployment.yaml -Raw
          $content = $content -replace 'DOCKERHUB_USERNAME', '${{ secrets.DOCKERHUB_USERNAME }}'
          $content = $content -replace 'quiz-app:latest', 'quiz-app:${{ github.sha }}'
          Set-Content k8s/deployment.yaml -Value $content
          Get-Content k8s/deployment.yaml

      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          Write-Host "Deploying to Kubernetes cluster..."
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          Write-Host "Waiting for deployment to be ready..."
          kubectl rollout status deployment/quiz-app --timeout=120s
          Write-Host "Deployment completed successfully!"

      - name: Verify Deployment
        shell: powershell
        run: |
          Write-Host "Checking deployment status..."
          kubectl get deployments
          kubectl get pods
          kubectl get services

      - name: Dummy DAST Scan
        shell: powershell
        run: |
          Write-Host "Running DAST scan against deployed application..."
          # In production, you would use tools like OWASP ZAP:
          # docker run -t owasp/zap2docker-stable zap-baseline.py -t http://<service-ip>
          Start-Sleep -Seconds 5
          Write-Host "DAST Scan completed."
